// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE & LICENSING
// ============================================

enum LicenseStatus {
  ACTIVE
  SUSPENDED
  EXPIRED
  GRACE_PERIOD
}

model SystemLicense {
  id                String        @id @default(uuid())
  licenseKey        String        @unique
  status            LicenseStatus
  validUntil        DateTime
  maxNodesAllowed   Int
  whitelabelEnabled Boolean       @default(false)
  signature         String
  gracePeriodEnds   DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

model Tenant {
  id          String   @id @default(uuid())
  name        String
  domain      String   @unique
  themeConfig Json? // { logoUrl, primaryColor, fontFamily }
  smtpConfig  Json? // { host, user, password }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users          User[]
  resourceQuotas ResourceQuota[]
}

enum UserRole {
  SUPERADMIN
  RESELLER_ADMIN
  USER
  SUPPORT
  SUPPORTER
}

model User {
  id                       String       @id @default(uuid())
  email                    String       @unique
  passwordHash             String
  provider                 AuthProvider @default(LOCAL)
  providerId               String?
  avatarUrl                String?
  role                     UserRole
  emailVerified            Boolean      @default(false)
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  twoFactorSecret          String?
  twoFactorEnabled         Boolean      @default(false)
  twoFactorMethod          String? // "TOTP" or "SMS"
  twoFactorBackupCodes     String?      @db.Text // JSON stringified array of hashed backup codes
  resetToken               String? // Hashed password reset token
  resetTokenExpires        DateTime? // Reset token expiration time
  balance                  Float        @default(0)
  tenantId                 String?
  tenant                   Tenant?      @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  createdAt                DateTime     @default(now())
  updatedAt                DateTime     @updatedAt

  ownedServers          GameServer[]           @relation("ServerOwner")
  auditLogs             AuditLog[]
  resolvedAlerts        Alert[]
  resourceQuotas        ResourceQuota[]
  apiKeys               ApiKey[]
  assignedIncidents     Incident[]             @relation("IncidentAssignee")
  orders                Order[]
  supportTickets        SupportTicket[]        @relation("TicketCreator")
  ticketComments        TicketComment[]        @relation("TicketComments")
  assignedTickets       SupportTicket[]        @relation("AssignedTickets")
  knowledgeBaseArticles KnowledgeBaseArticle[] @relation("KnowledgeBaseArticles")
  sessions              Session[]
  billingProfile        BillingProfile?

  @@index([provider, providerId])
}

enum AuthProvider {
  LOCAL
  GOOGLE
  DISCORD
}

model Session {
  id         String    @id @default(uuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token      String    @unique
  ip         String
  userAgent  String    @db.Text
  createdAt  DateTime  @default(now())
  lastActive DateTime  @updatedAt
  revokedAt  DateTime?

  @@index([userId])
  @@index([token])
  @@index([revokedAt])
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String // e.g., "DELETE_SERVER", "CHANGE_RCON_PASS"
  resourceId String
  ipAddress  String
  details    Json? // { oldValue, newValue }
  createdAt  DateTime @default(now())
}

// ============================================
// INFRASTRUCTURE (NODES & NETWORK)
// ============================================

enum DiskType {
  NVME
  SSD
  HDD
}

enum NodeStatus {
  PROVISIONING
  ONLINE
  OFFLINE
  MAINTENANCE
}

model Node {
  id                   String     @id @default(uuid())
  name                 String
  apiKey               String     @unique
  ipAddress            String
  publicFqdn           String?
  totalRam             Int // MB
  totalCpu             Int // Cores
  diskType             DiskType
  isClusterStorage     Boolean    @default(false)
  maintenanceMode      Boolean    @default(false)
  maxConcurrentUpdates Int        @default(2)
  status               NodeStatus @default(PROVISIONING)
  lastHeartbeat        DateTime?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  servers            GameServer[]
  networkAllocations NetworkAllocation[]
  metrics            Metric[]
  alerts             Alert[]
  storageClusters    GameCluster[]       @relation("StorageNode")
  tasks              Task[]
}

enum TaskStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// BILLING PROFILE
// ============================================

enum BillingType {
  INDIVIDUAL
  COMPANY
}

model BillingProfile {
  id          String      @id @default(uuid())
  userId      String      @unique
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        BillingType @default(INDIVIDUAL)
  fullName    String?
  companyName String?
  taxNumber   String?
  country     String
  city        String
  postalCode  String
  street      String
  phone       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([userId])
}

enum TaskType {
  PROVISION
  DEPROVISION
  START
  STOP
  RESTART
  UPDATE
  DELETE
  EXECUTE_COMMAND
}

model Task {
  id          String     @id @default(uuid())
  nodeId      String
  node        Node       @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  type        TaskType
  status      TaskStatus @default(PENDING)
  data        Json // Task-specific data (e.g., { serverUuid: "..." })
  error       String?
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([nodeId, status])
  @@index([status, createdAt])
}

enum Protocol {
  UDP
  TCP
}

enum PortType {
  GAME
  RCON
  QUERY
  APP
  TV
}

model NetworkAllocation {
  id         String      @id @default(uuid())
  nodeId     String
  node       Node        @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  port       Int
  protocol   Protocol
  type       PortType
  serverUuid String?
  server     GameServer? @relation(fields: [serverUuid], references: [uuid], onDelete: SetNull)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@unique([nodeId, port, protocol])
  @@index([nodeId, port])
  @@index([serverUuid])
}

model Subdomain {
  id           String     @id @default(uuid())
  subdomain    String
  domain       String
  serverUuid   String
  server       GameServer @relation(fields: [serverUuid], references: [uuid], onDelete: Cascade)
  cloudflareId String
  targetIP     String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([subdomain, domain])
  @@index([serverUuid])
}

// ============================================
// GAME LOGIC (SERVERS & CLUSTERS)
// ============================================

enum GameType {
  ARK
  RUST
  MINECRAFT
  CS2
  PALWORLD
  ATLAS
}

enum ServerStatus {
  INSTALLING
  RUNNING
  STOPPED
  STARTING
  STOPPING
  CRASHED
  UPDATING
}

model GameServer {
  id              String       @id @default(uuid())
  uuid            String       @unique
  gameType        GameType
  status          ServerStatus @default(INSTALLING)
  nodeId          String
  node            Node         @relation(fields: [nodeId], references: [id], onDelete: Restrict)
  ownerId         String
  owner           User         @relation("ServerOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  planId          String? // Optional reference to Plan
  plan            Plan?        @relation(fields: [planId], references: [id], onDelete: SetNull)
  startupPriority Int          @default(10)
  resources       Json // { cpuLimit, ramLimit, diskLimit }
  envVars         Json         @default("{}")
  clusterId       String?
  cluster         GameCluster? @relation(fields: [clusterId], references: [id], onDelete: SetNull)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  networkAllocations NetworkAllocation[]
  subdomains         Subdomain[]
  backups            Backup[]
  metrics            Metric[]
  alerts             Alert[]
  orders             Order[]
}

model GameCluster {
  id            String   @id @default(uuid())
  gameType      GameType
  sharedSecret  String // Hashed
  storageNodeId String
  storageNode   Node     @relation("StorageNode", fields: [storageNodeId], references: [id], onDelete: Restrict)
  mountPath     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  servers GameServer[]
}

enum BackupLocation {
  LOCAL
  S3
  HETZNER_BOX
}

model Backup {
  id             String         @id @default(uuid())
  serverUuid     String
  server         GameServer     @relation(fields: [serverUuid], references: [uuid], onDelete: Cascade)
  snapshotId     String
  sizeBytes      BigInt
  location       BackupLocation
  lastRestoredAt DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([serverUuid])
  @@index([createdAt])
}

model Metric {
  id               String      @id @default(uuid())
  nodeId           String
  node             Node        @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  serverUuid       String?
  server           GameServer? @relation(fields: [serverUuid], references: [uuid], onDelete: Cascade)
  timestamp        DateTime    @default(now())
  cpuUsage         Float // 0-100
  ramUsage         Float // MB
  ramUsagePercent  Float // 0-100
  diskUsage        Float // GB
  diskUsagePercent Float // 0-100
  networkIn        BigInt // Bytes
  networkOut       BigInt // Bytes
  uptime           Int? // Seconds

  @@index([nodeId, timestamp])
  @@index([serverUuid, timestamp])
  @@index([timestamp])
}

enum AlertSeverity {
  CRITICAL
  WARNING
  INFO
}

enum ResourceType {
  NODE
  SERVER
  SYSTEM
}

model Alert {
  id           String        @id @default(uuid())
  severity     AlertSeverity
  type         String // e.g., "NODE_OFFLINE", "SERVER_CRASH_LOOP"
  message      String // i18n key
  resourceId   String
  resourceType ResourceType
  resolved     Boolean       @default(false)
  resolvedAt   DateTime?
  resolvedById String?
  resolvedBy   User?         @relation(fields: [resolvedById], references: [id], onDelete: SetNull)
  metadata     Json? // Additional context
  nodeId       String?
  node         Node?         @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  serverUuid   String?
  server       GameServer?   @relation(fields: [serverUuid], references: [uuid], onDelete: Cascade)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([severity, resolved])
  @@index([resourceId, resourceType])
  @@index([createdAt])
}

model ResourceQuota {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId     String?
  tenant       Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  maxServers   Int
  maxRam       Int // MB
  maxDisk      Int // GB
  maxCpu       Int // Cores
  currentUsage Json // { servers, ram, disk, cpu }
  enforced     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId])
  @@index([tenantId])
}

model ApiKey {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  keyHash     String    @unique // SHA-256 hash
  name        String
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  permissions Json? // Array of allowed endpoints
  rateLimit   Int       @default(100)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([keyHash])
}

enum IncidentSeverity {
  P0
  P1
  P2
  P3
}

enum IncidentStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  CLOSED
}

model Incident {
  id                String           @id @default(uuid())
  title             String
  description       String
  severity          IncidentSeverity
  status            IncidentStatus   @default(OPEN)
  assignedToId      String?
  assignedTo        User?            @relation("IncidentAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  resolvedAt        DateTime?
  rootCause         String?
  resolution        String?
  affectedResources Json? // Array of Node/Server UUIDs
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([severity, status])
  @@index([assignedToId])
}

// ============================================
// BILLING & PLANS
// ============================================

enum PlanStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum PromotionScope {
  GLOBAL
  GAME
  PLAN
}

model Plan {
  id       String     @id @default(uuid())
  name     String // "Minecraft Basic", "Rust Premium", etc.
  slug     String     @unique // "minecraft-basic", "rust-premium"
  gameType GameType // Which game this plan is for
  status   PlanStatus @default(ACTIVE)

  // Resources
  ramMb    Int // RAM in MB
  cpuCores Int // CPU cores
  diskGb   Int // Disk in GB
  maxSlots Int? // Max players/slots (optional)

  // Pricing
  monthlyPrice Int // Price in smallest currency unit (e.g., Ft * 100 for decimals)
  hourlyPrice  Int? // Optional hourly pricing
  setupFee     Int  @default(0)

  // Features
  features Json? // Array of feature strings: ["Automatic backups", "DDoS protection"]

  // Display
  description String? @db.Text
  isPopular   Boolean @default(false)
  sortOrder   Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  servers    GameServer[]
  orders     Order[]
  promotions Promotion[]

  @@index([gameType, status])
  @@index([slug])
}

model Promotion {
  id              String         @id @default(uuid())
  name            String
  description     String?
  scope           PromotionScope
  discountPercent Int
  gameType        GameType?
  planId          String?
  plan            Plan?          @relation(fields: [planId], references: [id], onDelete: SetNull)
  startDate       DateTime
  endDate         DateTime?
  active          Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([scope, active])
  @@index([gameType, active])
  @@index([planId, active])
  @@index([startDate])
  @@index([endDate])
}

model Order {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

  status OrderStatus @default(PENDING)

  // Pricing snapshot (in case plan changes)
  priceSnapshot Json // { monthlyPrice, setupFee, features, resources }

  totalAmount Int // Total price
  currency    String @default("HUF")

  // Payment
  paymentMethod String? // "stripe", "barion", "manual"
  paymentId     String? // External payment reference
  paidAt        DateTime?

  // Server details
  serverId String?     @unique
  server   GameServer? @relation(fields: [serverId], references: [uuid])

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum OrderStatus {
  PENDING
  PAYMENT_PENDING
  PAID
  PROVISIONING
  ACTIVE
  CANCELLED
  REFUNDED
}

// ============================================
// PAYMENTS - EVENTS & IDEMPOTENCY
// ============================================

enum PaymentProvider {
  BARION
  PAYPAL
  UPAY
}

enum PaymentEventStatus {
  RECEIVED
  PROCESSED
  FAILED
}

model PaymentEvent {
  id          String             @id @default(uuid())
  provider    PaymentProvider
  eventType   String // e.g., "callback", "webhook"
  eventId     String // Provider event/token identifier (unique per provider+type)
  paymentId   String?
  orderId     String?
  status      PaymentEventStatus @default(RECEIVED)
  payload     Json?
  error       String?
  createdAt   DateTime           @default(now())
  processedAt DateTime?
  updatedAt   DateTime           @updatedAt

  @@unique([provider, eventType, eventId])
  @@index([paymentId])
  @@index([orderId])
}

// ============================================
// SUPPORT SYSTEM
// ============================================

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
}

model SupportTicket {
  id           String         @id @default(uuid())
  ticketNumber String         @unique
  subject      String
  description  String         @db.Text
  priority     TicketPriority @default(MEDIUM)
  category     String? // e.g., "billing", "technical", "general"
  status       TicketStatus   @default(OPEN)

  // Assignment
  assignedToId String?
  assignedTo   User?     @relation("AssignedTickets", fields: [assignedToId], references: [id], onDelete: SetNull)
  assignedAt   DateTime?

  // SLA Tracking
  slaResponseDeadline DateTime? // When first response is due
  slaResolveDeadline  DateTime? // When resolution is due
  firstResponseAt     DateTime? // When first staff response was made

  // Relations
  userId String
  user   User   @relation("TicketCreator", fields: [userId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?

  // Relations
  comments TicketComment[]

  @@index([userId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([slaResponseDeadline])
  @@index([slaResolveDeadline])
}

model SlaPolicy {
  id                String         @id @default(uuid())
  priority          TicketPriority @unique
  responseTimeHours Int // Hours to first response
  resolveTimeHours  Int // Hours to resolution
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model TicketComment {
  id       String        @id @default(uuid())
  ticketId String
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation("TicketComments", fields: [authorId], references: [id], onDelete: Cascade)

  message String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ticketId])
  @@index([authorId])
}

// Knowledge Base System
model KnowledgeBaseArticle {
  id      String  @id @default(uuid())
  title   String
  slug    String  @unique
  content String  @db.Text
  excerpt String? @db.Text

  categoryId String
  category   KnowledgeBaseCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation("KnowledgeBaseArticles", fields: [authorId], references: [id])

  tags Json @default("[]") // JSON array of tag strings for MySQL compatibility

  published  Boolean @default(false)
  views      Int     @default(0)
  helpful    Int     @default(0)
  notHelpful Int     @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  versions ArticleVersion[]

  @@index([categoryId])
  @@index([authorId])
  @@index([published])
  @@index([slug])
}

model KnowledgeBaseCategory {
  id          String  @id @default(uuid())
  name        String  @unique
  slug        String  @unique
  description String? @db.Text
  icon        String? // Optional icon name/emoji
  order       Int     @default(0) // Display order

  parentId String?
  parent   KnowledgeBaseCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children KnowledgeBaseCategory[] @relation("CategoryHierarchy")

  articles KnowledgeBaseArticle[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([order])
}

model ArticleVersion {
  id        String               @id @default(uuid())
  articleId String
  article   KnowledgeBaseArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  version Int // Version number
  title   String
  content String  @db.Text
  excerpt String? @db.Text

  createdBy String
  createdAt DateTime @default(now())

  @@unique([articleId, version])
  @@index([articleId])
}

// ============================================
// INVOICE METADATA - SEQUENTIAL NUMBERING
// ============================================

model InvoiceMetadata {
  id String @id @default(uuid())

  // Tenant-specific or global invoice counter
  tenantId String? // null = global counter

  // Sequential numbering
  prefix         String   @default("INV") // e.g., "INV", "INVOICE"
  sequenceNumber Int      @default(1) // Incremental sequence: 1, 2, 3...
  lastUsedDate   DateTime @default(now())

  // Year-based reset (optional)
  year Int? // If set, counter resets each year

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, prefix, year])
  @@index([tenantId])
}

// ============================================
// HOMEPAGE SLIDESHOW - HERO MEDIA MANAGEMENT
// ============================================

enum MediaType {
  IMAGE
  VIDEO
  YOUTUBE
}

model HomepageSlide {
  id String @id @default(uuid())

  title       String
  description String? @db.Text

  mediaType MediaType
  mediaUrl  String // Local path or YouTube URL

  linkUrl  String? // Optional CTA button link
  linkText String? // CTA button text (default: "Tudj meg t√∂bbet")

  sortOrder Int     @default(0) // Display order
  isActive  Boolean @default(true)

  publishedFrom  DateTime? // Optional scheduling
  publishedUntil DateTime? // Optional expiration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, sortOrder])
  @@index([publishedFrom, publishedUntil])
}
