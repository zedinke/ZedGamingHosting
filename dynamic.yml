http:
  routers:
    # Frontend - Root domain
    web-http:
      rule: "Host(`zedgaminghosting.hu`) || Host(`www.zedgaminghosting.hu`)"
      entryPoints:
        - web
      service: web
      middlewares:
        - redirect-to-https

    web-https:
      rule: "Host(`zedgaminghosting.hu`) || Host(`www.zedgaminghosting.hu`)"
      entryPoints:
        - websecure
      service: web
      middlewares:
        - security-headers
        - add-charset-header
      tls:
        certResolver: letsencrypt
      priority: 1

    # API - /api routes
    api-http:
      rule: "(Host(`zedgaminghosting.hu`) || Host(`www.zedgaminghosting.hu`)) && PathPrefix(`/api`)"
      entryPoints:
        - web
      service: api
      middlewares:
        - redirect-to-https

    api-https:
      rule: "(Host(`zedgaminghosting.hu`) || Host(`www.zedgaminghosting.hu`)) && PathPrefix(`/api`)"
      entryPoints:
        - websecure
      service: api
      middlewares:
        - security-headers
        - api-ratelimit
      tls:
        certResolver: letsencrypt
      priority: 10

    api-metrics-https:
      rule: "(Host(`zedgaminghosting.hu`) || Host(`www.zedgaminghosting.hu`)) && PathPrefix(`/api/metrics`)"
      entryPoints:
        - websecure
      service: api
      middlewares:
        - security-headers
        - api-ratelimit
        - metrics-ipallow
      tls:
        certResolver: letsencrypt
      priority: 15

    # Adminer - Database Admin
    adminer-http:
      rule: "Host(`zedgaminghosting.hu`) && PathPrefix(`/adminer`)"
      entryPoints:
        - web
      service: adminer
      middlewares:
        - redirect-to-https
      priority: 20

    adminer-https:
      rule: "Host(`zedgaminghosting.hu`) && PathPrefix(`/adminer`)"
      entryPoints:
        - websecure
      service: adminer
      middlewares:
        - security-headers
      tls:
        certResolver: letsencrypt
      priority: 20

    # Grafana - Monitoring Dashboard
    grafana-http:
      rule: "Host(`grafana.zedgaminghosting.hu`)"
      entryPoints:
        - web
      service: grafana
      middlewares:
        - redirect-to-https
      priority: 30

    grafana-https:
      rule: "Host(`grafana.zedgaminghosting.hu`)"
      entryPoints:
        - websecure
      service: grafana
      middlewares:
        - security-headers
      tls:
        certResolver: letsencrypt
      priority: 30

  middlewares:
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true

    security-headers:
      headers:
        stsSeconds: 15552000
        stsIncludeSubdomains: true
        stsPreload: true
        forceSTSHeader: true
        contentTypeNosniff: true
        frameDeny: true
        referrerPolicy: "no-referrer-when-downgrade"
        permissionsPolicy: "camera=(), microphone=(), geolocation=(), payment=()"

    metrics-ipallow:
      ipAllowList:
        sourceRange:
          - "127.0.0.1/32"
          - "116.203.226.140/32"

    api-ratelimit:
      rateLimit:
        average: 100
        burst: 200
        period: 1m

    add-charset-header:
      headers:
        customResponseHeaders:
          Content-Type: "text/html; charset=utf-8"

  services:
    web:
      loadBalancer:
        servers:
          - url: "http://zed-web:3000"

    api:
      loadBalancer:
        servers:
          - url: "http://zed-api:3000"

    adminer:
      loadBalancer:
        servers:
          - url: "http://zed-adminer:8080"

    grafana:
      loadBalancer:
        servers:
          - url: "http://zed-grafana:3000"
